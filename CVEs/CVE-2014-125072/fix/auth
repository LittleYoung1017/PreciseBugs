<?php 
if (isset($_COOKIE['session_auth'])) {
  include "/data/klattr.com/www/includes/open_db";
  include "/data/klattr.com/www/includes/evaluate_cookie";
  $ip = $_SERVER['HTTP_X_REAL_IP'];
  if ($ip == "") {
    $ip = $_SERVER['REMOTE_ADDR'];
  }
  $cookie_key = $_COOKIE['session_auth'];
/* Sanitize $cookie_key */
  $cookie_key = htmlspecialchars($cookie_key);
  $cookie_key = addslashes($cookie_key);

  $UID = evaluate_cookie($cookie_key, $ip);
  if ($UID !== 0) {
    /*  $UID is now an SQL injection attack
        if UID is just Numeric - then so if(!ctype_digit($UID)) { return false; }
    */
    $sql = "SELECT Handle, Name, Profile_Text, Avatar, Email_Addr, Activated FROM Users WHERE ID='$UID'";
    $sql_result = mysqli_query($con,$sql);
    $row = mysqli_fetch_array($sql_result);
    $uname = $row['Handle'];
    $rname = $row['Name'];
    $uEmailAddr = $row['Email_Addr'];
    $profile = $row['Profile_Text'];
    if (empty($row['Avatar'])) {
      $userPic = "/gfx/default_user.png";
    } else {
      $userPic = $uname . ".jpeg";
    }
    if ($row['Activated'] == 1 || $activatePage == 1) {
      $auth = 1;
    } else {
      header( 'Location: https://klattr.com/activate.php' );
    }
    


  } else {
    $auth = 0;
  }
} else {
  $auth = 0;
}
